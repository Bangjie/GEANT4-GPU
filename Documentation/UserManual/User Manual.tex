\documentclass[12pt]{article}

% Packages
\usepackage[margin=1.2in]{geometry}
\usepackage{graphicx}
\usepackage{enumerate}
\usepackage{listings}
\usepackage{titling}
\usepackage{tabularx}
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{makecell}
\usepackage{caption}
\usepackage{array}
\lstset{basicstyle=\small\ttfamily,xleftmargin=18pt}
\captionsetup[table]{skip=2pt}
% Comments --------------------------------------------------------------------
\usepackage{xcolor}
\newif\ifcomments\commentstrue
\ifcomments \newcommand{\authornote}[3]{\textcolor{#1}{[#3 ---#2]}}
\newcommand{\todo}[1]{\textcolor{red}{[TODO: #1]}} \else
\newcommand{\authornote}[3]{} \newcommand{\todo}[1]{} \fi
\newcommand{\wss}[1]{\authornote{magenta}{SS}{#1}}
\newcommand{\ds}[1]{\authornote{blue}{DS}{#1}}
\newcommand{\mmp}[1]{\authornote{green}{MP}{#1}}
% End Comments ---------------------------------------------------------------

\setlength\parindent{0pt} % Cleaner look


% Title Page -----------------------------------------------------------------
\title{
\LARGE GEANT-4 GPU Port:
\\\vspace{10mm}
\large \textbf{User Manual}
\vspace{40mm}
}
\author{
Stuart Douglas -- dougls2
\\Matthew Pagnan -- pagnanmm
\\Rob Gorrie -- gorrierw
\\Victor Reginato -- reginavp
\vspace{10mm}
}
\date{\vfill \textbf{Version 0}\\ \today}
% End Title Page -------------------------------------------------------------

% ============================== BEGIN DOCUMENT ============================= %
\begin{document}
\pagenumbering{gobble} % start numbering after TOC

% ============================== Title Page ============================= %
\maketitle
\newpage

% ================================= TOC ================================= %
\newgeometry{bottom=1.1in, top=1.1in}
\tableofcontents
\newpage
\pagenumbering{arabic}
\restoregeometry

% =============================== Section =============================== %
\section{Revision History}
All major edits to this document will be recorded in the table below.

\begin{table}[h]
\centering
\caption{Revision History}\label{Table_Revision}
\begin{tabular}{lll}
\toprule
\bf Description of Changes & \bf Author & \bf Date\\\midrule
Initial draft of document & Matt & 2016-02-26\\
\bottomrule
\end{tabular}
\end{table}

% =============================== Section =============================== %
\section{List of Figures}
\begin{center}
\begin{tabular}{cl}
\toprule
\bf Table \# & \bf Title\\\midrule
\bottomrule
\end{tabular}
\end{center}

\section{Definitions and Acronyms} % Matt
\begin{table}[h]
\centering
\caption{Definitions and Acronyms}
\begin{tabularx}{\textwidth}{l|X}
\Xhline{2\arrayrulewidth}
\bf Term & \bf Description\\
\hline
Geant-4 & open-source software toolkit used to simulate the passage of particles through matter\\\hline
Geant-GPU & Geant-4 with some computations running on the GPU\\\hline
G4-STORK & (Geant-4 STOchastic Reactor Kinetics), fork of Geant-4 developed by McMaster's Engineering Physics department to simulate McMaster's nuclear reactor\\\hline
GPU & graphics processing unit, well-suited to parallel computing tasks\\\hline
CPU & computer processing unit, general computer processor well-suited to serial tasks\\\hline
CUDA & parallel computing architecture for general purpose programming on GPU, developed by NVIDIA\\\hline
\Xhline{2\arrayrulewidth}
\end{tabularx}
\end{table}


% =============================== Section =============================== %

\section{Introduction} % Rob
\subsection{Purpose} % Rob
\subsection{Scope} % Rob	
\subsection{Background} % Rob
\subsection{Document Overview} % Matt
This document goes over how to install and run Geant4-GPU. As well as software and hardware required for Geant4-GPU to be installed and run. Following this are detailed step-by-step instructions on how to install the software. Following details on installation is a section on creating and running simulations using the CUDA functionality introduced in Geant4-GPU. A section detailing high level details about how the CUDA code was developed and integrated follows, guiding future developers and users on how to integrate CUDA into other parts of Geant4. A troubleshooting section is included as well as a FAQ section covering many common questions related to the project. Finally, the appendix includes conclusions about the state of the project and a brief description of the future of the project.

\section{Legal Information}	% Victor

\section{Installation} % Victor

\subsection{Supported Operating Systems} % Victor
Currently, the only operating systems GEANT4-GPU has been tested on are OS X 10.11 and  Red Hat Enterprise Linux Server release 6.7 (Santiago). Other versions of these operating systems are likely to work, but compatibility is not guaranteed.\\
To check what version of OS X you have, perform the following actions:
\begin{enumerate}
\item Click on the blue apple icon in the top left-hand corner of your screen.
\item Click on About This Mac.
\item Check to ensure that the version of your OS is 10.11 (El Capitan) (earlier versions may work, but are not guaranteed).
\end{enumerate}
To check your version of RHEl, perform the following actions:
\begin{enumerate}
\item Open a shell.
\item Type in the following command "cat /etc/redhat-release" or "uname -m \&\& cat /etc/*release"
\item Check to ensure that the version of RHEL installed is 6.7 (Santiago) (earlier versions may work, but are not guaranteed).
\end{enumerate}

\subsection{Recommended Knowledge} % Victor

\subsection{Required Hardware} % Victor
In order to successfully install and run GEANT4 with GPU parallelism, you must first check that the workstation that you are installing on has a NVIDIA GPU with Compute Capability 3.0 or higher.\\
To check if the GPU on your current workstation supports CUDA with a Compute Capability of 3.0 or higher, perform the following actions:\\
%Commented out pending a successful windows installation
%Windows:\\
%\begin{enumerate}
%\item Determine the graphics card that is currently installed.
%\begin{enumerate}
%\item Simply right-click on your desktop.
%\item Look for any item in the drop down that says "NVIDIA Control Panel" or "NVIDIA Display" 
%\item Click whichever of the two options you see in order to check the name of your card.
%\end{enumerate}
%\item Visit https://developer.nvidia.com/cuda-gpus and find your GPU to determine the Compute Capability of your card. 
%\item Ensure that the Compute Capability is 3.0 or higher.
%\end{enumerate}

Redhat:
\begin{enumerate}
\item Determine the graphics card that is currently installed.
\begin{enumerate}
\item Open a shell.
\item Enter the following command "lspci | grep -i nvidia".
\item You should see output similar to the following:\\
01:00.0 VGA compatible controller: NVIDIA Corporation GK104GL [Quadro K5000] (rev a1)
\item Where [Quadro K5000] is the name of your NVIDIA Graphics Card.
\end{enumerate}
\item Visit \href{https://developer.nvidia.com/cuda-gpus}{NVIDIA} and find your GPU to determine the Compute Capability of your card.
\item Check to ensure that you have a NVIDIA GPU with a  Compute Capability of at least 3.0.
\item If you can't find the currently installed GPU on the list, it is not CUDA compatible.
\end{enumerate}

OS X 10.11 (El Capitan):
\begin{enumerate}
\item Determine the graphics card that is currently installed.
\begin{enumerate}
\item Click on the blue apple icon in the top left-hand corner of your screen.
\item Click on About This Mac.
\item Click on More Info...
\item Under Contents click Hardware to view it's options.
\item Click on Graphics/Displays.
\item You should see the name of your card at the top of the right view-pane.
\end{enumerate}
\item Visit \href{https://developer.nvidia.com/cuda-gpus}{NVIDIA} and find your GPU to determine the Compute Capability of your card.
\item Check to ensure that you have a NVIDIA GPU with a  Compute Capability of at least 3.0.
\item If you can't find the currently installed GPU on the list, it is not CUDA compatible.
\end{enumerate}

\subsection{Required Software} % Victor
In order to install GEANT4-GPU you must have the following software installed:
\begin{itemize}
\item GCC version 4.8 or 4.9
\item CUDA Toolkit v6.5 (the only version of the CUDA Toolkit tested and working)
\item cmake 3.3 or higher
\end{itemize}
\textbf{GCC}\\
\textbf{Check GCC RHEL 6.7:}\\
To check which version of the GCC you have installed on your system, perform the following actions:
\begin{enumerate}
\item Open a shell.
\item Enter "gcc -v" into the command line.
\item You will see output that looks like:\\
gcc version 4.9.2 20150212 (Red Hat 4.9.2-6) (GCC)
\item Ensure that the version is 4.8 or 4.9
\end{enumerate}

\textbf{Check GCC (or Clang packaged with Xcode 6)}
\begin{enumerate}
\item Open a shell.
\item Enter "clang --version" into the command line.
\item You will see output similar to: \\
Apple LLVM version 6.0 (clang-600.0.51) (based on LLVM 3.5svn) \\
Target: x86\_64-apple-darwin13.3.0 \\
Thread model: posix
\item Ensure that your version of Clang is clang-600.x.xx
\end{enumerate}
\textbf{CUDA Toolkit}\\

If you don't already have the CUDA Toolkit installed, visit \href{https://developer.nvidia.com/cuda-toolkit-65}{NVIDIA CUDA Toolkit v6.5} and follow the installation instructions for your OS.\\

After installing, check to see that CUDA is up and running. For either RHEL 6.7 or OS X 10.11:
\begin{enumerate}
\item Open a shell.
\item Enter the following command "nvcc --version"
\item Output should be similar to:\\
nvcc: NVIDIA (R) Cuda compiler driver\\
Copyright (c) 2005-2014 NVIDIA Corporation\\
Built on Thu\_Jul\_17\_21:41:27\_CDT\_2014\\
Cuda compilation tools, release 6.5, V6.5.12\\
\end{enumerate}

\textbf{CMake}
If you don't already have cmake (version 3.3 or higher) you can install it from: \href{https://cmake.org/download/}{CMake}

After installing cmake, check to see that it is up and running. For either RHEL 6.7 or OS X 10.11:
\begin{enumerate}
\item Open a shell.
\item Enter the following command "cmake --version".
\item Output should be similar to:\\
cmake version 3.4.0\\
\\
CMake suite maintained and supported by Kitware (kitware.com/cmake).
\end{enumerate}

\subsection{Installation Instructions} % Victor
Included in the repository, there is a README.md that breaks down the installation steps, including special instructions on how to install this on McMaster's servers. That document is also covered in this section of the user guide. \\
\begin{enumerate}
%NOTE: The repo is private at the moment, so obtaining th source files would be difficult.
\item Either clone the repository or download it from \href{https://github.com/studouglas/GEANT4-GPU}{Github GEANT4-GPU}
\item A few quick edits to the source will be necessary in order to install.
\item Edit the file to:   /GEANT4-GPU/geant4.10.02/source/externals/cuda/include/G4ParticleHPVector_CUDA.hh \\
So that this line:
#include "/Users/stuart/Documents/4th_Year/CS_4ZP6/GEANT4-GPU/geant4.10.02/source/externals/cuda/include/G4ParticleHPVector_CUDA.hh"\\
 Points to the actual path of the file:\\
#include "/Users/You/Downloads/GEANT4-GPU/geant4.10.02/source/externals/cuda/include/G4ParticleHPVector_CUDA.hh"
\item 
\item mkdir /path/to/GEANT4-GPU/geant4.10.00.p02-build /path/to/GEANT4-GPU/
\end{enumerate}
\section{Execution} % Stuart
Geant4 is not an executable program in the traditional sense. It is instead a large set of libraries, designed to work together and that give you, the user, a framework to develop simulations for your work. The development of such simulations is not within the scope of this manual, but it is well-documented with a thorough guide available at \url{http://geant4.web.cern.ch/geant4/UserDocumentation/UsersGuides/ ForApplicationDeveloper/html/index.html}.\\

This section will instead outline how one would go about using (or not using) CUDA computations with an existing simulation. The \texttt{Hadr04} example that comes with Geant4 will be used as the simulation to demonstrate this.

\subsection{Enabling/Disabling CUDA} % Stuart
The installation guide details how to build the Geant4 libraries that will be used by your simulation. The Cmake command from step \ref{StepCmake} includes a flag that determines whether or not CUDA will be used -- \texttt{-DGEANT4\_ENABLE\_CUDA=ON}. Changing this value to \texttt{OFF} will cause Geant4 to build without any CUDA features, and without requiring \texttt{nvcc}, the CUDA compiler. After step \ref{StepCmake} finishes, users will have to rebuild Geant4 by executing the \texttt{make install} command from their \texttt{geant4.10.02-build} directory. To re-enable CUDA, simply change the value to \texttt{ON} and rebuild again.

\subsection{Building the Simulation} % Stuart
After Geant4 has been built, building the simulation is very straightforward. First, navigate to your simulation's root folder (\texttt{geant4.10.02/examples/hadronic/Hadr04} in our case) in your terminal. Then, create a new directory \texttt{bin}, so your Hadr04 folder now has two folders, \texttt{bin} and \texttt{src}. Go into the \texttt{bin} folder and run \texttt{cmake ../src} followed by \texttt{make}. That's it!

\subsection{Running the Simulation} % Stuart
There are two main methods of running a Geant4 simulation. The first is to simply run the executable, in our case by running \texttt{./Hadr04} in the Hadr04 directory. This launches an interactive Geant4 command prompt, and you can manipulate all aspects of the simulation from within it, including the types of particles, their number, and their energies. This also allows you to visualize the simulation using the \texttt{vis} commands.\\

The alternative is to create a macro file that contains a sequence of commands that would be manually given to the interactive prompt, making it much easier to run a given simulation more than once and without requiring user interaction. Both methods print the results of the simulation out to the terminal window, as well as the running time of the simulation. If you wish to save the results to a file, that can easily be done via redirection in Unix. For example, if you wish to save the results of your simulation using \texttt{myMacro.mac} to \texttt{results.txt}, simply run \texttt{./Hadr04 myMacro.mac > results.txt}.

\section{Porting Other Geant4 Modules to CUDA} % Stuart
There is currently one class in Geant4-GPU that uses CUDA -- G4ParticleHPVector. This class was originally chosen as it was thought to be well-suited to parallelism. Although certain functions within the class are, the majority of the time spent within the class is not in these functions, the main reason for the performance degradations when CUDA is enabled.\\

There is indeed the possibility that there are other classes within Geant4 that are better suited to parallelism. This section will outline the general methodology we used to port G4ParticleHPVector with the hopes that it may be of use to future developers or users.

\subsection{Layout of Source Files} % Stuart
An important consideration during development was to keep the CUDA code separate from the main Geant4 codebase as much as possible. We created a folder named \texttt{cuda} in \texttt{geant4.10.02/source/externals} to contain all CUDA source code. The \texttt{cuda} folder contains two folders, \texttt{include} and \texttt{src}. All header files are in \texttt{include}, and the CUDA source files are in \texttt{src}.

\subsection{CMake Changes} % Stuart
Geant4 uses CMake as its build system, and minor modifications need to be made to integrate with CUDA. This consists of adding a variable at the top level CMakeLists file to enable or disable CUDA, and creating a {Geant4\_Add\_Library\_Cuda} macro to Geant4MacroLibraryTargets. This uses \texttt{cuda\_add\_library} function included in Cmake. More details can be found in the project's detailed design document.

\subsection{Interfacing with Existing Code} % Stuart
We used compiler directives within the default G4ParticleHPVector.cc file to make use of the CUDA code or to use the original implementation based on the flag passed to Geant4 during the build phase. If the flag is true, an object of type G4ParticleHPVector\_CUDA is initialized and all function calls become one line calls to the corresponding function on the G4ParticleHPVector\_CUDA object. For example, the \texttt{GetY} function looks like the following:
\begin{lstlisting}
G4double GetY(int i) {
	#if GEANT4_ENABLE_CUDA
		return cudaVector->GetY();
	#else
		< existing code from G4ParticleHPVector.cc >
	#endif
}
\end{lstlisting}


\subsection{Naming Conventions} % Stuart
It is important to use naming conventions to ensure clarity within a project that contains many possible ambiguities. The two main conventions we used were adding a ``\_CUDA" suffix to all source files within the \texttt{cuda} directory as well as to the class name of any classes implemented in CUDA. In addition to this, within all CUDA files there are two main types of pointer -- those to GPU memory and those to CPU memory. To distinguish between these, all pointers to main memory are prepended with ``h\_'' and pointers to GPU memory with a ``d\_''.

\section{Troubleshooting} % Matt
\subsection{Installation} % Matt
\begin{itemize}
\item Ensure path names are correct in Cmake command
\item Spaces in path names may cause issues on some systems
\item The paths in step \ref{StepCmake} of installing Geant-4 paths must be absolute
\item Newer versions of Clang (included with Xcode 7) have been know to cause problems. Download Xcode 6 and uninstall Xcode 7 if this is the case.
\end{itemize}

\subsection{Running the Simulation} % Matt 
\begin{itemize}
\item Ensure that your graphics card meets the requirements detailed in section \ref{SecCardReqs}
\end{itemize}

\subsection{FAQ} % Matt
\subsubsection{What is Geant-4?}
Many physics researchers use Geant-4 to learn about how particles interact with a specific environment. It is a toolkit (i.e. set of libraries) that uses the Monte Carlo model, meaning each particle's properties are calculated independently according to certain probabilities. Users develop simulations based on these libraries.

\subsubsection{Why will a GPU improve the performance?}
GPU's contain a large amount of cores that can perform calculations much more quickly than a CPU if the problem is well-suited to parallelization. Geant-4 runs relatively simple calculations on millions of particles, and each particle is completely independent of the others. This is exactly that sort of well-suited problem, and stands to see large performance gains.

\subsubsection{Where can I find more information about Geant-4?}
For more information, checkout the official website at \url{http://www.geant4.web.cern.ch/geant4/index.shtml}

\subsubsection{Helpful Pages:}
\begin{itemize}
\item Download page for Geant4 source code: \url{http://www.geant4.web.cern.ch/geant4/support/download.shtml}
\item Getting Started guide: \url{http://www.geant4.web.cern.ch/geant4/support/gettingstarted.shtml}
\item Installation Guide for Geant4 (does not include CUDA): \url{http://www.geant4.web.cern.ch/geant4/UserDocumentation/UsersGuides/InstallationGuide/html/index.html}
\end{itemize}

\section{Appendix} % Rob
\subsection{Recommendations for Integration of Geant4 and CUDA}
\subsection{Future of Geant4-GPU}

\end{document}
