<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html401/loose.dtd">
<html>
<!-- Created on April, 15 2011 by texi2html 1.78 -->
<!--
Written by: Lionel Cons <Lionel.Cons@cern.ch> (original author)
            Karl Berry  <karl@freefriends.org>
            Olaf Bachmann <obachman@mathematik.uni-kl.de>
            and many others.
Maintained by: Many creative people.
Send bugs and suggestions to <texi2html-bug@nongnu.org>

-->
<head>
<title>TOP-C (Task Oriented Parallel C/C++): B. Example TOP-C Application</title>

<meta name="description" content="TOP-C (Task Oriented Parallel C/C++): B. Example TOP-C Application">
<meta name="keywords" content="TOP-C (Task Oriented Parallel C/C++): B. Example TOP-C Application">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="texi2html 1.78">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
pre.display {font-family: serif}
pre.format {font-family: serif}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
pre.smalldisplay {font-family: serif; font-size: smaller}
pre.smallexample {font-size: smaller}
pre.smallformat {font-family: serif; font-size: smaller}
pre.smalllisp {font-size: smaller}
span.roman {font-family:serif; font-weight:normal;}
span.sansserif {font-family:sans-serif; font-weight:normal;}
ul.toc {list-style: none}
-->
</style>


</head>

<body lang="en" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#800080" alink="#FF0000">

<a name="Example"></a>
<a name="SEC60"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="topc_11.html#SEC59" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="topc_13.html#SEC61" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="topc_11.html#SEC59" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="topc.html#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="topc_13.html#SEC61" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="topc.html#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="topc_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="topc_14.html#SEC62" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="topc_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h1 class="appendix"> B. Example &lsquo;<samp>TOP-C</samp>&rsquo; Application </h1>


<p>There are several example &lsquo;<samp>TOP-C</samp>&rsquo; programs in the
&lsquo;<tt>topc/examples</tt>&rsquo; subdirectory.  We include one example in this
manual.  It does not contain any <code>UPDATE</code> actions, and therefore
illustrates only a trivial form of parallelism (with no interaction
among the slaves).  The &lsquo;<tt>topc/examples</tt>&rsquo; subdirectory should be
inspected for more sophisticated examples.
After understanding this example, you may also want to look at
<a href="topc_8.html#SEC39">Advanced Features of &lsquo;<samp>TOP-C</samp>&rsquo;</a>, or if you are parallelizing a sequential
program, then you may want to look at <a href="topc_9.html#SEC54">&lsquo;<samp>TOP-C</samp>&rsquo; Raw Interface for Parallelizing Sequential Code</a>.
</p>
<p>This program produces an array of 10,000,000 random integers in one pass,
and then finds the maximum value in a second pass.  It would be compiled
by: <code>topcc <var>MODE</var> &lsquo;<tt>file.out</tt>&rsquo;</code>, where <var>MODE</var> is one of
<code>--seq</code>, <code>--mpi</code>, or <code>--pthread</code>.  One can control the
number of slaves by executing:  <code>./a.out --TOPC-num-slaves=<var>num</var></code>.
</p>
<table><tr><td>&nbsp;</td><td><pre class="example">#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdio.h&gt;
#include &lt;topc.h&gt;

#define MAX 2000000
#define INCR MAX/10 /* We assume INCR divides MAX exactly */

int array[MAX];
int idx;
int max_int;

TOPC_BUF GenerateTaskInput() {
  int input_task;
  if (idx &gt;= MAX) return NOTASK;
  input_task = idx;
  idx = idx + INCR;
  return TOPC_MSG( &amp;input_task, sizeof(input_task) );
}
TOPC_BUF DoTaskRandom( int *ignore ) {
  int rand_int[INCR];
  int i;
  for ( i = 0; i &lt; INCR; i++)
    rand_int[i] = rand();
  return TOPC_MSG( rand_int, INCR * sizeof(int) );
}
TOPC_ACTION CheckTaskRandom( int *input, int rand_vals[] ) {
  int curr_idx = *input;
  memcpy( array+curr_idx, rand_vals, INCR * sizeof(int) );
  return NO_ACTION;
}

TOPC_BUF GenerateTaskInMax() {
  int *input_task;
  if (idx &gt;= MAX) return NOTASK;
  input_task = array + idx;
  idx = idx + INCR;
  return TOPC_MSG( input_task, INCR * sizeof(int) );
}
TOPC_BUF DoTaskMax( int subarray[] ) {
  int i;
  int max=0;
  for ( i = 0; i &lt; INCR; i++)
    if ( subarray[i] &gt; max )
      max = subarray[i];
  return TOPC_MSG( &amp;max, sizeof(max) );
}
TOPC_ACTION CheckTaskMax( int ignore[], int *output ) {
  int curr_max = *output;
  if ( curr_max &gt; max_int )
    max_int = curr_max;
  return NO_ACTION;
}

int main( int argc, char **argv ) {
  /* Set default to no trace; Override with:  ./a.out --TOPC-trace=1 */
  TOPC_OPT_trace = 0;
  TOPC_init( &amp;argc, &amp;argv );
  idx = 0; /* Initialize idx, and randomize values of array[] */
  TOPC_master_slave(GenerateTaskInput, DoTaskRandom, CheckTaskRandom,
                    NULL);
  if (TOPC_is_master())
    printf(&quot;Finished randomizing integers.\n&quot;);
  idx = 0; /* Re-initialize idx to 0, and find max. value in array[] */
  TOPC_master_slave( GenerateTaskInMax, DoTaskMax, CheckTaskMax, NULL );
  TOPC_finalize();
  printf(&quot;The maximum integer is:  %d\n&quot;, max_int);
  exit(0);
}
</pre></td></tr></table>



<hr size="6">
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="topc_11.html#SEC59" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="topc_13.html#SEC61" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="topc.html#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[<a href="topc_toc.html#SEC_Contents" title="Table of contents">Contents</a>]</td>
<td valign="middle" align="left">[<a href="topc_14.html#SEC62" title="Index">Index</a>]</td>
<td valign="middle" align="left">[<a href="topc_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<p>
 <font size="-1">
  This document was generated by <em>Gene Cooperman</em> on <em>April, 15 2011</em> using <a href="http://www.nongnu.org/texi2html/"><em>texi2html 1.78</em></a>.
 </font>
 <br>

</p>
</body>
</html>
