# @configure_input@

exec_prefix=@PWD@

CC=@CC@
MPICC=@MPICC@
CFLAGS=@CFLAGS@ -I@PWD@/include
DEFS=@DEFS@

LIBDIR=@PWD@/lib
INCLUDEDIR=@PWD@/include

# Set to "strip" or to "strip -f" (check your man page) for smaller binaries
STRIP=@STRIP@

@SET_MAKE@

OBJS_SEQ=topc.o memory-no-pthread.o options-no-pthread.o procgroup.o
OBJS_MPI=topc.o memory.o options-no-pthread.o procgroup.o
OBJS_PTHREAD=topc.o memory.o options.o procgroup.o

all: ${LIBDIR}/libtopc.a ${LIBDIR}/libtopc-seq.a ${LIBDIR}/libmpinu.a \
	${LIBDIR}/libtopc-pthread.a

${LIBDIR}/libtopc.a:  ${LIBDIR}/libtopc-mpi.a
	( cd ${LIBDIR}; rm -f libtopc.a; ln -s libtopc-mpi.a libtopc.a )

${LIBDIR}/libtopc-mpi.a:  ${OBJS_MPI} comm-mpi.o ${LIBDIR}/libmpinu.a
	rm -f ${LIBDIR}/libtopc-mpi.a
	ar qc ${LIBDIR}/libtopc-mpi.a ${OBJS_MPI} comm-mpi.o
	${STRIP} ${LIBDIR}/libtopc-mpi.a;

${LIBDIR}/libtopc-seq.a:  ${OBJS_SEQ} comm-seq.o
	rm -f ${LIBDIR}/libtopc-seq.a
	ar qc ${LIBDIR}/libtopc-seq.a ${OBJS_SEQ} comm-seq.o
	${STRIP} ${LIBDIR}/libtopc-seq.a;

${LIBDIR}/libtopc-pthread.a:  ${OBJS_PTHREAD} comm-pthread.o
	rm -f ${LIBDIR}/libtopc-pthread.a
	- ar qc ${LIBDIR}/libtopc-pthread.a ${OBJS_PTHREAD} comm-pthread.o
	${STRIP} ${LIBDIR}/libtopc-pthread.a;

${INCLUDEDIR}/mpinu.h:  mpinu/mpi.h
	cp mpinu/mpi.h ${INCLUDEDIR}/mpinu.h

${LIBDIR}/libmpinu.a: mpinu/libmpi.a
	cp mpinu/libmpi.a ${LIBDIR}/libmpinu.a
	${STRIP} ${LIBDIR}/libmpinu.a;

mpinu/libmpi.a:
	( cd mpinu; ${MAKE} libmpi.a )

${INCLUDEDIR}/topc.h: @PWD@/src/topc.h
	cp @PWD@/src/topc.h ${INCLUDEDIR}/topc.h

topc.o: topc.c topc.h comm.h
	${CC} -c ${CFLAGS} topc.c
	cp topc.h ${INCLUDEDIR}/topc.h

memory.o: memory.c topc.h comm.h sem-pthread.h
	${CC} -c ${CFLAGS} ${DEFS} memory.c
options.o: options.c topc.h comm.h
	${CC} -c ${CFLAGS} ${DEFS} \
	 -DVER_STR='"@TOPC_VERSION@"' -DUPDATE_STR='"@TOPC_UPDATED@"' options.c
procgroup.o: procgroup.c comm.h
	${CC} -c ${CFLAGS} ${DEFS} procgroup.c

memory-no-pthread.o: memory.c topc.h comm.h
	${CC} -c -o memory-no-pthread.o ${CFLAGS} ${DEFS} \
	  -DHAVE_PTHREAD=0 memory.c
options-no-pthread.o: options.c topc.h comm.h
	${CC} -c -o options-no-pthread.o ${CFLAGS} ${DEFS} -DHAVE_PTHREAD=0 \
	 -DVER_STR='"@TOPC_VERSION@"' -DUPDATE_STR='"@TOPC_UPDATED@"' options.c

comm-mpi.o: comm-mpi.c comm.h ${INCLUDEDIR}/mpinu.h
	${MPICC} -c ${CFLAGS} ${DEFS} comm-mpi.c

comm-seq.o: comm-seq.c comm.h ${INCLUDEDIR}/mpinu.h
	${CC} -c ${CFLAGS} ${DEFS} comm-seq.c

comm-pthread.o: comm-pthread.c comm.h sem-pthread.h
	@if test "x@HAVE_PTHREAD@" != "xyes"; then \
	  echo ""; \
	  echo "WARNING:  I couldn't find pthread.h; comm-pthread.o may fail"; \
	  echo "          If pthread is desired, and pthread.h is not"; \
	  echo "            in a standard location, try copying it to:"; \
	  echo "            @PWD@/{include}/"; \
	  echo "          If libpthread.{a,so} is needed, then modify"; \
	  echo "            LIBSFORPTHREAD everywhere in bin/topc-config.in"; \
	  echo "Alternatively, if you do not use shared memory, ignore this."; \
	  echo ""; \
	fi
	- ${CC} -c ${CFLAGS} ${DEFS} comm-pthread.c

#Targets of convenience
libmpinu.a: ${LIBDIR}/libmpinu.a
libtopc.a: ${LIBDIR}/libtopc.a
libtopc-mpi.a: ${LIBDIR}/libtopc-mpi.a
libtopc-seq.a: ${LIBDIR}/libtopc-seq.a
libtopc-pthread.a: ${LIBDIR}/libtopc-pthread.a

clean:
	( cd mpinu; ${MAKE} clean )
	rm -f *.o a.out core

distclean: clean
	rm -f *~
